<plugin>
    <b>Mscolab Windy Interface</b>
    <div class="plugin-content">
        <div class="tab">
            <button class="tablinks active" id="login_link">Login</button>
            <button class="tablinks" id="project_link">Projects</button>
          </div>
        <div id="login_tab" class="tabcontent" style="display: block;">
            Please enter credentials <br>

            <input type="text" id="mscolab_url" value="http://localhost:8083" placeholder="Mscolab URL">
            <input type="text" id="mscolab_email" value="test@test" placeholder="Your Email">
            <input type="text" id="mscolab_password" value="test" placeholder="Your Password">
            <button id="mscolab_login">Login</button>
        </div>

        <div id="project_tab" class="tabcontent">
            <div id="project_username"></div><br>
            <div id="project_list"></div><br>
            Waypoints<br>
            <ul id="waypoint_list"></ul>
        </div>
    </div>
    <script>
        import map from '@windy/map';
        import bcast from '@windy/broadcast';
        var websocket = null;
        var token = null;
        var projects = null;
        var userId = null;
        var msc_url = "http://localhost:8083";
        var waypoints = [];
        var markers = [];
        var socket = null;

        const icon = L.divIcon({
            className: 'weather-at-city',
            iconSize: [80, 40],
            iconAnchor: [40, 20],
        });

        function openTab(tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName.replace("tab", "link")).className += " active";
        }

        function requestMsc(endpoint="", method="Get", data={"token": token}, callback=null){
            var url = msc_url + "/" + endpoint;
            var request_data = {}
            if(method == "Get"){
                var start_char = "?";
                for(var key in data){
                    url += start_char + key + "=" + data[key];
                    start_char = "&";
                }
                request_data = {method: method}
            } else {
                var formdata = new FormData();
                for (var key in data) {
                    formdata.append(key, data[key]);
                }
                request_data = {method: method, body: formdata}
            }
            if(callback == null){
                return fetch(url, request_data).then(response => {console.log(response); return response.json();});
            } else {
                fetch(url, request_data).then(response => {console.log(response); return response.json();}).then(r_data => callback(r_data));
            }
        }

        function projectUpdated(event){
            console.log(event);
            event = JSON.parse(event);
            const p_id = event["p_id"];
            const u_id = event["u_id"];
            if(p_id == getSelectedProject() && u_id != userId){
                console.log('Updating project ' + p_id);
                projectSelected();
            }
        }

        function addWaypoint(event){
            const latlon = event.latlng;
            console.log(latlon);
        }

        function drawWaypoints(){
            if (markers) {
                markers.forEach(m => map.removeLayer(m));
                markers = [];
            }
            const latlons = waypoints.map(x => [x["lat"], x["lon"]]);
            const line = L.polyline(latlons, {
                            color: `rgb(20, 20, 140)`,
                            weight: 4,
                        }).addTo(map);
            markers.push(line);
            
            document.getElementById("waypoint_list").innerHTML = "";
            for(var i = 0; i < waypoints.length; i++){
                const waypoint = waypoints[i];
                document.getElementById("waypoint_list").innerHTML += `<li id="WP_${i}">${i + 1}. (${waypoint["lat"]}, ${waypoint["lon"]}) ${waypoint["name"]}</li>`;
                const marker = L.marker([waypoint["lat"], waypoint["lon"]]).addTo(map);
                marker.bindPopup(waypoint["name"]);
                markers.push(marker);
            }
            for(var i = 0; i < waypoints.length; i++){
                document.getElementById("WP_"+i).onclick = waypoints[i]["zoom"];
            }
        }

        function projectSelected(){
            var id = getSelectedProject();

            function loadProject(response_data){
                var parser = new DOMParser();
                var project = parser.parseFromString(response_data.content, "text/xml");
                var xml_waypoints = project.getElementsByTagName("Waypoint");
                waypoints = [];
                var max_lat = -1000;
                var min_lat = 1000;
                var max_lon = -1000;
                var min_lon = 1000;
                for(var waypoint of xml_waypoints){
                    const lat = waypoint.getAttribute("lat");
                    const lon = waypoint.getAttribute("lon");
                    const alt = waypoint.getAttribute("flightlevel");
                    const name = waypoint.getAttribute("location");
                    max_lat = max_lat < lat ? lat : max_lat;
                    max_lon = max_lon < lon ? lon : max_lon;
                    min_lat = min_lat > lat ? lat : min_lat;
                    min_lon = min_lon > lon ? lon : min_lon;
                    waypoints.push({"lat": lat, "lon": lon, "alt": alt, "name": name, "zoom": () => map.setView({ lat: lat, lng: lon })})
                }
                var southWest = L.latLng(min_lat, min_lon),
                    northEast = L.latLng(max_lat, max_lon),
                    bounds = L.latLngBounds(southWest, northEast);
                map.fitBounds(bounds);
                drawWaypoints();
            }

            var data = {"token": token, "p_id": id};
            requestMsc("get_project_by_id", "Get", data, loadProject);
        }

        function getSelectedProject(){
            return document.getElementById("selected_project").value;
        }

        function postLogin(response_data){
            token = response_data["token"];
            var data = {"token": token}
            var username = response_data["user"]["username"];
            userId = response_data["user"]["id"];
            var test = document.getElementById("project_username");
            test.innerHTML = "Logged in as " + username;
            socket = io.connect(msc_url);
            // Add a connect listener
            socket.on('connect',function() {
                console.log('Client has connected to the server!');
                socket.emit("start", data);
            });
            // Add a connect listener
            socket.on('file-changed', projectUpdated);
            // Add a disconnect listener
            socket.on('disconnect',function() {
                console.log('The client has disconnected!');
                socket.disconnect();
                openTab("login_tab");
            });

            openTab("project_tab")

            function listProjects(response_data){
                projects = response_data["projects"];
                document.getElementById("project_list").innerHTML = `Projects: <select name="projects" id="selected_project"></select>`;
                for(var project_index in projects){
                    var project = projects[project_index];
                    document.getElementById("selected_project").innerHTML += `<option value="${project['p_id']}">${project["path"]}</option>`;
                }
                document.getElementById("selected_project").onchange = projectSelected;
            }
            requestMsc("projects", "Get", data, listProjects);
        }

        function loginMsc(){
            msc_url = document.getElementById("mscolab_url").value;
            var email = document.getElementById("mscolab_email").value;
            var password = document.getElementById("mscolab_password").value;
            var data = {"password": password, "email": email};
            requestMsc("token", "Post", data, postLogin);
        }

        console.log('I am mounted to the page');
        console.log(loginMsc);
        document.getElementById("mscolab_login").onclick = loginMsc;
        document.getElementById("login_link").onclick = () => openTab("login_tab");
        document.getElementById("project_link").onclick = () => openTab("project_tab");
        map.on("click", addWaypoint);

        this.onclose = () => console.log('I am being closed');
    </script>
</plugin>
